---
title: "Final Assignment"
author: "Emma Pérez & Andrés Camargo"
date: "2023-05-19"
output: html_document
---

```{r setup,  warning=FALSE, message=FALSE, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Libraries

```{r, warning=FALSE, message=FALSE}
library(tidyverse)
library(igraph)
library(visNetwork)
library(ggplot2)
library(ggthemes)
library(caret)
set.seed(123)

```


## 0. Network 

*LastFM Asia Social Network*

We will continue working with the social network of LastFM Asian users, which is available at the [Stanford Network Analysis Platform (SNAP)](https://snap.stanford.edu/index.html). Last.fm is a social media, an internet radio, and also a music recommendation system that builds profiles and statistics about musical preferences, based on data sent by registered users.

According to SNAP, the data was collected from the public API in March 2020. Nodes are LastFM users from Asian countries and edges are mutual follower relationships between them. The vertex features are extracted based on the artists liked by the users. It can be downloaded in csv format from [LastFM Asia Social Network](https://snap.stanford.edu/data/feather-lastfm-social.html). 

To start with, the data is loaded to R. 

```{r}
fm = read_delim("lasftm_asia/lastfm_asia_edges.csv", delim=",")
g = graph.data.frame(fm, directed = FALSE)
```

## a) Epidemic threshold

*Find the theoretical epidemic threshold βc for your network for the information to reach a significant number of nodes.*

```{r}
mu <- 0.1
betac <- mu*mean(degree(g))/(mean(degree(g)^2))
betac
```
The parameter mu stands for the recovery rate. It is the rate at which infected individuals recover and become immune to the disease. The epidemic threshold is defined as the minimum value of the transmission rate β required for an epidemic to occur and persist in a population. 

Assuming $mu = 0.1$, the epidemic threshold in our network is very small $(0.0039)$, because of the heterogeneity in the degree distribution $(⟨k⟩ = 7.3$ and $⟨k^2⟩ = 185.4$, so $⟨k^2⟩>>⟨k⟩)$. Therefore,as the epidemic threshold βc is really small, it is very easy to spread in this network!


## b) SIR simulation

*Assuming that randomly-selected 1% of the nodes of your network knows about the information, simulate the SIR model below and above that threshold and plot the number of infected people as a function of β.*

First, we create the function for the SIR simulation, which contains the parameters for the network (g), the beta or transmission rate (beta), the mu or recovery rate (mu) and the seeds (initial number of people infected).

```{r}
sim_sir <- function(g,beta,mu,seeds){
  state <- rep(0,vcount(g)) #initial state of the simulation
  state[seeds] <- 1 #infect the seeds
  t <- 0
  table <- data.frame(t=0,inf=seeds)
  while(sum(state==1)>0){
    t <- t + 1
    #I -> R
    infected <- which(state==1)
    state[infected] <- ifelse(runif(length(infected)) < mu,2,1)
    
    #S -> I
    infected <- which(state==1)
    susceptible <- which(state==0) #get them
    contacts <- as.numeric(unlist(adjacent_vertices(g,infected))) #get the contacts of infected
    contacts <- contacts[contacts %in% susceptible]
    new_infected <- contacts[runif(length(contacts)) < beta] #infect contacts
    if(length(new_infected)>0){
      state[new_infected] <- 1
      table <- rbind(table,data.frame(t,inf=new_infected))
    }
  }
  table
}
```

Now, we set the seeds to be 1% randomly chosen nodes, and set the beta value to be between 0 and 0.25 by 0.005. 
The value of mu is fixed to 0.1 as before. 

```{r}
results <- map_dfr(seq(0,0.25,0.005),
        \(beta){ seeds <- sample(1:vcount(g),vcount(g)*0.01)
        realization <- sim_sir(g,beta,mu,seeds)
        data.frame(beta,ninf=nrow(realization))
        })
results %>% ggplot(aes(x=beta,y=ninf))+ geom_point()+
  geom_vline(xintercept = betac,linetype=2)
```



## c) Acelerate Spreading

*Choose a β above βc. Using centrality, communities or any other metric, find a better set of 1% of seeds in the network so we get more infected people than the random case. Measure the difference of your choice with the random case as: *
- *The difference in the total number of infected people*
- *The difference in the time of the peak of infection (when most infections happen). * 

First, we generate the realization with a β above βc, to then check which metrics are the most correlated with the time of infection. 

```{r}
seeds <- sample(1:vcount(g),vcount(g)*0.01)
realization <- sim_sir(g,beta=0.2,mu=0.1,seeds)

```

```{r}
# Node degree
table_d <- degree(g) %>% enframe(name = "inf",value="degree") %>%
  merge(realization) 

table_d %>% 
  ggplot(aes(x=t,y=degree)) + geom_point() + scale_y_log10()
```

```{r}
# Closeness
table_c <- closeness(g,cutoff=2) %>% enframe(name = "inf",value="closeness") %>%
  merge(realization) 
table_c %>% 
  ggplot(aes(x=t,y=closeness)) + geom_point() + scale_y_log10()
```

```{r}
# Betweenness 
table_b <- betweenness(g) %>% enframe(name = "inf",value="betweenness") %>%
  merge(realization) 
table_b %>% 
  ggplot(aes(x=t,y=betweenness)) + geom_point() + scale_y_log10()
```

```{r}
# Page Rank
table_pr <- page_rank(g)$vector %>% enframe(name = "inf",value="page_rank") %>%
  merge(realization) 
table_pr %>% 
  ggplot(aes(x=t,y=page_rank)) + geom_point() + scale_y_log10()
```

Let's see which one best predict the time to infection: 

```{r}
table <- merge(table_d,table_c)
table <- merge(table,table_pr)
table <- merge(table,table_b)
cor(table$t,table[,-c(1,2)])
```
Page Rank seems to be the best

Now, we can compare the realizations with the random seeds and with the seeds selected by higher page rank.

```{r}
#Random realization
seeds <- sample(1:vcount(g),vcount(g)*0.01)#1% random seed

realization_random <- sim_sir(g,beta = 0.15,mu=0.1,seeds) %>%
  group_by(t) %>% summarize(ninf=n())

#Targeted nodes realization
seeds <- page_rank(g)$vector %>% enframe(name = "inf",value="page_rank") %>%
  slice_max(page_rank,n=round(vcount(g)*0.01))#1% seeds of highest page rank

realization_targeted <- sim_sir(g,beta = 0.15,mu=0.1, as.vector(as.integer(seeds$inf))) %>%
  group_by(t) %>% summarize(ninf=n())

#Graph for comparison 
ggplot() + geom_line(data=realization_random,aes(x=t,y=ninf,col="Random"))+
  geom_line(data=realization_targeted,aes(x=t,y=ninf,col="Targeted"))
```


We can see than infecting first the nodes with higher centrality the peak is reached sooner in time, and the number of nodes infected is higher than with random spread. Thus, selecting the seeds according to centrality metrics does accelerate the spreading. 


```{r}
#Random realization
seeds <- sample(1:vcount(g),vcount(g)*0.01)#1% random seed

realization_random <- sim_sir(g,beta = 0.15,mu=0.1,seeds) %>%
  group_by(t) %>% summarize(ninf=n())

#Targeted nodes realization
seeds <- betweenness(g) %>% enframe(name = "inf",value="betweenness") %>%
  slice_max(betweenness,n=round(vcount(g)*0.01))#1% seeds of highest page rank

realization_targeted <- sim_sir(g,beta = 0.15,mu=0.1, as.vector(as.integer(seeds$inf))) %>%
  group_by(t) %>% summarize(ninf=n())

#Graph for comparison 
ggplot() + geom_line(data=realization_random,aes(x=t,y=ninf,col="Random"))+
  geom_line(data=realization_targeted,aes(x=t,y=ninf,col="Targeted"))
```


We obtain the same result when trying with betweenness metric. 

Therefore, if we want the information to spread faster we should target the nodes with larger centrality.

## d) Inmunization

*Suppose now that you can convince 5% of people in the network not to spread that information at all:*

- *Choose those 5% randomly in the network. Simulate the SIR model above βc using 1% of the remaining nodes as seeds. Choose those seeds randomly.*
- *Choose those 5% according to their centrality. Simulate the SIR model above βc using 1% of the remaining nodes as seeds. Choose those seeds randomly.* 
- *Measure the difference between both cases as you did in part c).*

First, we simulate the SIR model using a random 5% of people 
```{r}
seeds <- sample(1:vcount(g),vcount(g)*0.01)
realization <- sim_sir(g,beta = 0.5,mu=0.1,seeds) %>%
  group_by(t) %>% summarize(ninf=n())
vaccinated_random <- sample(1:vcount(g),vcount(g)*0.05)#5% randomly chosen
gp <- delete_vertices(g,vaccinated_random)
seeds <- sample(1:vcount(gp),vcount(gp)*0.01)
realization_random <- sim_sir(gp,beta = 0.5,mu=0.1,seeds) %>%
  group_by(t) %>% summarize(ninf=n())
```

Then, we run the simulation with the 5% chosen according to their centrality (those nodes with largest page rank)

```{r}
seeds <- page_rank(g)$vector %>% enframe(name = "inf",value="page_rank") %>%
  slice_max(page_rank,n=round(vcount(g)*0.05))#5% according to page_rank 
gp <- delete_vertices(g,seeds$inf)
seeds <- sample(1:vcount(gp),vcount(gp)*0.01)
realization_targeted <- sim_sir(gp,beta = 0.5,mu=0.1,seeds) %>%
  group_by(t) %>% summarize(ninf=n())
```

Let's see the difference between both cases: 

```{r}
ggplot() + geom_line(data=realization,aes(x=t,y=ninf,col="No Vaccination")) +
  geom_line(data=realization_random,aes(x=t,y=ninf,col="Vacc. Random"))+
  geom_line(data=realization_targeted,aes(x=t,y=ninf,col="Vacc. Targeted"))
```

Random vaccination has an effect similar to no vaccination at all with regard to the time at which the peak is reached. However, the infected nodes in the peak is higher with no vaccination than with random. Since in our network is very heterogeneous, we would need to vaccinate randomly a lot of nodes to stop the spreading. 

On the contrary, targeted vaccination based on Page Rank centrality measure does more than half the peak of infected people (from 4000 to 1500), which is reached later in time (at time 5 instead of time 2.5)



## e) Analysis of Inmunization

*Comment on the relationship between the findings in part c) and d) using the same type of centrality for the 1% in part c) and 5% in part d).*

According to the graphs obtained in part c) and d), selecting the seeds based on higher _Page Rank_ leads to faster spreading (c). Similarly, when targeting immunization using PageRank, it delays the peak of spreading (d). This is because we have identified nodes in the network that have a higher influence on spreading. The impact generated by nodes with higher centrality is reflected in the propagation throughout the network, triggering cascades of influence that result in greater spread of the behavior in case c) or reduced spreading in case d).

## f) Improve inmunization

*With the results of part b) train a model that predicts that time to infection of a node using their degree, centrality, betweeness and page rank. Use that model to select the seed nodes as those with the smallest time to infection in part c).*

```{r}

```


*Repeat d).*

```{r}

```

